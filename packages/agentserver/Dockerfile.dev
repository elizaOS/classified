# ElizaOS Agent Server - Development Build (builds from source)
FROM oven/bun:1-debian

# Install runtime dependencies including PostgreSQL client
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    dumb-init \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package files for dependency installation
COPY package.json ./
COPY packages/agentserver/package.json ./packages/agentserver/

# Copy workspace packages that agentserver depends on
COPY packages/core/package.json ./packages/core/
COPY packages/plugin-bootstrap/package.json ./packages/plugin-bootstrap/
COPY packages/plugin-sql/package.json ./packages/plugin-sql/

# Install dependencies
RUN bun install --frozen-lockfile

# Copy source code
COPY packages/agentserver/ ./packages/agentserver/
COPY packages/core/ ./packages/core/
COPY packages/plugin-bootstrap/ ./packages/plugin-bootstrap/
COPY packages/plugin-sql/ ./packages/plugin-sql/

# Build all dependencies
WORKDIR /app/packages/core
RUN bun run build

WORKDIR /app/packages/plugin-sql
RUN bun run build

WORKDIR /app/packages/plugin-bootstrap
RUN bun run build

WORKDIR /app/packages/agentserver
RUN bun run build

# Create necessary directories
RUN mkdir -p /app/data /app/logs /app/knowledge

# Copy startup script
COPY packages/agentserver/docker-startup.sh ./docker-startup.sh
RUN chmod +x ./docker-startup.sh

# Copy health check script
COPY packages/agentserver/scripts/health-check.sh ./health-check.sh
RUN chmod +x ./health-check.sh

# Health check endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD ["./health-check.sh"]

# Expose port
EXPOSE 7777

# Environment variables for production
ENV NODE_ENV=production \
    PORT=7777 \
    LOG_LEVEL=info \
    DOCKER_CONTAINER=true \
    POSTGRES_URL="postgresql://eliza:eliza_secure_pass@eliza-postgres:5432/eliza" \
    DATABASE_URL="postgresql://eliza:eliza_secure_pass@eliza-postgres:5432/eliza" \
    OLLAMA_BASE_URL="http://eliza-ollama:11434" \
    OLLAMA_API_ENDPOINT="http://eliza-ollama:11434/api" \
    KNOWLEDGE_PATH="/app/knowledge" \
    RESET_DB=false

# Use dumb-init for proper signal handling
ENTRYPOINT ["dumb-init", "--"]
CMD ["bun", "run", "start"] 